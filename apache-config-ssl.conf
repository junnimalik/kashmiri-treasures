<IfModule mod_ssl.c>
<VirtualHost *:443>
        ServerName kashmiricraft.com
        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/kashmiri-treasures/dist

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # SSL Configuration
        SSLCertificateFile /etc/letsencrypt/live/kashmiricraft.com/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/kashmiricraft.com/privkey.pem
        Include /etc/letsencrypt/options-ssl-apache.conf

        # Enable required modules for reverse proxy
        # Make sure these are enabled: a2enmod proxy proxy_http ssl

        # Reverse Proxy for Backend API
        # This routes /api/* requests to the FastAPI backend on port 8000
        ProxyPreserveHost On
        ProxyPass /api http://localhost:8000/api
        ProxyPassReverse /api http://localhost:8000/api

        # Also proxy /uploads for serving uploaded images
        ProxyPass /uploads http://localhost:8000/uploads
        ProxyPassReverse /uploads http://localhost:8000/uploads

        # Handle CORS and OPTIONS requests
        <LocationMatch "^/api">
            Header set Access-Control-Allow-Origin "https://kashmiricraft.com"
            Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Header set Access-Control-Allow-Headers "Content-Type, Authorization"
            Header set Access-Control-Allow-Credentials "true"
        </LocationMatch>

        # Frontend SPA routing - serve index.html for all non-file requests
        <Directory /var/www/kashmiri-treasures/dist>
            Options -Indexes +FollowSymLinks
            AllowOverride All
            Require all granted
            
            # Handle React Router - serve index.html for all routes
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
        </Directory>

        # Security Headers
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
</VirtualHost>
</IfModule>
